# Loại bỏ malware với Active response trên Windows

Khi VirusTotal xác định một tệp là mối đe dọa, chúng ta có thể định cấu hình Wazuh để kích hoạt Active response để xóa tệp khỏi điểm cuối.
  
- Hàm os.remove() trong tập lệnh Active response sẽ xử lý việc xóa tệp độc hại: os.remove(msg.alert["parameters"]["alert"]["data"]["virustotal"]["source"]["file"])

Cấu hình trên Windows agent để theo dõi các thay đổi gần thời gian thực trong thư mục. Các bước này cũng cài đặt các gói cần thiết và tạo tập lệnh phản hồi hoạt động để xóa các tệp độc hại.

Chúng ta tiến hành chuyển đổi tập lệnh python Active remove-threat.py thành ứng dụng thực thi bằng cách sử dụng các bước sau:

 - Tải xuống và giải nén mã nguồn PyInstaller

 - Chạy trình cài đặt Python sau khi tải xuống. Đảm bảo chọn các hộp sau:
   
   - Install launcher for all users

   - Add Python 3.X to PATH

 - Khi Python hoàn tất quá trình cài đặt, hãy mở PowerShell với quyền quản trị viên và sử dụng để cài đặt PyInstaller:
   
   - pip install pyinstaller
   
   -  pyinstaller –version

![cài đặt PyInstaller](/Images/wazuh-015.png)
 
- Tạo tập lệnh phản hồi hiện hoạt để xóa tệp khỏi điểm cuối Windows: remove-threat.py
 
 ![Tạo tập lệnh remove-threat.py 1](/Images/wazuh-016.png)
 
 ![Tạo tập lệnh remove-threat.py 2](/Images/wazuh-017.png)
 
 ![Tạo tập lệnh remove-threat.py 3](/Images/wazuh-018.png)
 
 ![Tạo tập lệnh remove-threat.py 4](/Images/wazuh-019.png)
 
- Chuyển đổi tập lệnh Python thành tệp thực thi Windows. Chạy lệnh PowerShell sau với quyền quản trị viên để tạo tệp thực thi: pyinstaller -F C:\Users\duc\Downloads\remove-threat.py

![Chuyển đổi tập lệnh Python thành tệp thực thi Windows 1](/Images/wazuh-020.png)

![Chuyển đổi tập lệnh Python thành tệp thực thi Windows 2](/Images/wazuh-021.png)

- Hãy lưu ý đường dẫn nơi tạo. remove-threat.exe

- Di chuyển tệp thực thi remove-threat.exe từ thư mục C:\Windows\system32\dist vào thư mục C:\Program Files (x86)\ossec-agent\active-response\bin
 
 ![Di chuyển tệp thực thi remove-threat.exe từ thư mục C:\Windows\system32\dist vào thư mục C:\Program Files (x86)\ossec-agent\active-response\bin](/Images/wazuh-022.png)
 
- Để áp dụng các thay đổi, hãy khởi động lại agent bằng cách chạy lệnh PowerShell sau với tư cách quản trị viên: Restart-Service -Name wazuh

**Cấu hình trên Wazuh manager**

- Chúng ta thêm các cấu hình sau vào file ossec.conf trên Wazuh manager để bật tích hợp VirusTotal. Điều này cho phép kích hoạt truy vấn VirusTotal bất cứ khi nào bất kỳ quy tắc nào trong nhóm FIM được kích hoạt:

![Thêm cấu hình vào file ossec.conf trên Wazuh manager để bật tích hợp VirusTotal](/Images/wazuh-023.png)

- Chúng ta tiến hành cấu hình Active response trên Wazuh manager. 

![Cấu hình Active response trên Wazuh manager](/Images/wazuh-024.png)

- Sau khi hoàn tất cấu hình Active response, chúng ta tạo các Rule để cảnh báo cho chúng ta biết Active response có thành công hay không. Chúng ta sẽ thêm Rule vào file local_rules.xml trên Wazuh manager:
 
![Thêm Rule vào file local_rules.xml trên Wazuh manager](/Images/wazuh-025.png)
 
- Khởi động lại trình Wazuh manager để áp dụng các thay đổi cấu hình: systemctl restart wazuh-manager

- Chúng ta sẽ tải một malware test file từ trang web vào thư mục được giám sát trên Windows: 

  - Invoke-WebRequest -Uri https://secure.eicar.org/eicar.com.txt -OutFile eicar-hnvd.txt

  - cp .\ eicar-hnvd.txt C:\Users\duc\Downloads
 
- VirusTotal sẽ phát hiện được tệp độc hại eicar-hnvd.txt và Active response sẽ thực hiện việc xóa tệp độc hại
 
![VirusTotal sẽ phát hiện được tệp độc hại eicar-hnvd.txt và Active response sẽ thực hiện việc xóa tệp độc hại](/Images/wazuh-026.png)
 
  - Thông tin chi tiết về malwave
 
 ![Thông tin chi tiết về malwave](/Images/wazuh-027.png)
 
 ![Thông tin chi tiết về malwave 2](/Images/wazuh-028.png)
 
  - Active response đã xóa tệp độc hại

![Active response đã xóa tệp độc hại](/Images/wazuh-029.png)

![Active response đã xóa tệp độc hại 2](/Images/wazuh-030.png)

![Active response đã xóa tệp độc hại 3](/Images/wazuh-031.png)
